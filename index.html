<!DOCTYPE html>
<html lang="mg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Microtâche Mila Vola</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3498db;
      --secondary: #2c3e50;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fb, #e3e9f7);
      color: #333;
      min-height: 100vh;
      padding-bottom: 3rem;
    }
    
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      color: white;
      padding: 1.5rem 0;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .app-title {
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      font-size: 1.8rem;
    }
    
    .app-subtitle {
      font-weight: 300;
      opacity: 0.9;
      font-size: 1rem;
    }
    
    .nav-pills {
      background: white;
      border-radius: 50px;
      padding: 0.5rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .nav-pills .nav-link {
      border-radius: 50px;
      padding: 0.5rem 1.25rem;
      font-weight: 500;
      color: var(--gray);
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .nav-pills .nav-link.active, 
    .nav-pills .nav-link:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }
    
    .section-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      padding: 1.75rem;
      margin-bottom: 1.5rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: none;
    }
    
    .section-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .section-title {
      color: var(--secondary);
      font-weight: 700;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--primary);
      display: inline-block;
    }
    
    .balance-card {
      text-align: center;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    
    .gain-card {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
    }
    
    .deposit-card {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }
    
    .balance-label {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }
    
    .balance-amount {
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0;
    }
    
    .btn-action {
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-action i {
      margin-right: 8px;
    }
    
    .btn-deposit {
      background: var(--primary);
      color: white;
    }
    
    .btn-withdraw {
      background: var(--warning);
      color: white;
    }
    
    .btn-action:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .task-card {
      margin-bottom: 1rem;
      border-radius: 12px;
      overflow: hidden;
      border: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
    }
    
    .task-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .task-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--warning);
      color: white;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-size: 0.85rem;
    }
    
    .admin-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .admin-header {
      color: var(--secondary);
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    
    .request-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary);
    }
    
    .request-card h6 {
      font-weight: 600;
      color: var(--secondary);
    }
    
    .request-card pre {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .modal-content {
      border-radius: 15px;
      overflow: hidden;
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
    }
    
    .referral-code {
      background: #e3f2fd;
      color: var(--primary);
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      font-weight: 700;
      font-size: 1.25rem;
      display: inline-block;
      margin-top: 0.5rem;
    }
    
    .stats-container {
      display: flex;
      justify-content: space-around;
      margin: 1.5rem 0;
    }
    
    .stat-item {
      text-align: center;
      padding: 1rem;
    }
    
    .stat-number {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
      text-transform: uppercase;
    }
    
    .form-control, .form-select {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 1px solid #e1e5eb;
      transition: all 0.3s;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.2);
    }
    
    footer {
      background: var(--secondary);
      color: white;
      text-align: center;
      padding: 1.5rem 0;
      margin-top: 2rem;
      border-radius: 20px 20px 0 0;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .firebase-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      z-index: 1000;
    }
    
    .status-connected {
      background-color: var(--success);
      color: white;
    }
    
    .status-disconnected {
      background-color: var(--danger);
      color: white;
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--gray);
      border: 2px dashed #eee;
      border-radius: 10px;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: #ddd;
    }
    
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 2rem;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .login-logo {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .login-logo i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }
    
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    .admin-table th {
      background: var(--secondary);
      color: white;
      padding: 0.75rem;
      text-align: left;
    }
    
    .admin-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #eee;
    }
    
    .admin-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    .admin-table tr:hover {
      background-color: #e9ecef;
    }
    
    .admin-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    
    .logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }
    
    .completed-task {
      opacity: 0.6;
      position: relative;
    }
    
    .completed-task:after {
      content: "Asa vita";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-10deg);
      background: var(--success);
      color: white;
      font-weight: bold;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      z-index: 10;
    }
    
    .referral-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 1.5rem;
    }
    
    .referral-link {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .referral-link input {
      flex: 1;
      border-radius: 10px 0 0 10px;
    }
    
    .referral-link button {
      border-radius: 0 10px 10px 0;
    }
    
    .professional-gradient {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
    }
    
    .professional-shadow {
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .btn-professional {
      background: linear-gradient(to right, #1a2a6c, #b21f1f);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .btn-professional:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      background: linear-gradient(to right, #1a2a6c, #c82333);
    }
    
    .card-header-gradient {
      background: linear-gradient(to right, #1a2a6c, #b21f1f);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px 12px 0 0 !important;
    }
    
    .stat-item-professional {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      text-align: center;
      transition: all 0.3s;
    }
    
    .stat-item-professional:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
      .section-card {
        padding: 1.25rem;
      }
      
      .nav-pills {
        padding: 0.25rem;
      }
      
      .nav-pills .nav-link {
        padding: 0.5rem;
        font-size: 0.85rem;
      }
      
      .stats-container {
        flex-direction: column;
      }
      
      .app-title {
        font-size: 1.5rem;
      }
      
      .admin-table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Page de connexion -->
  <div id="loginPage" class="container">
    <div class="login-container professional-shadow">
      <div class="login-logo">
        <i class="fas fa-tasks"></i>
        <h2>Microtâche Mila Vola</h2>
        <p>Plateforme pour gagner de l'argent en réalisant des microtâches</p>
      </div>
      
      <form id="loginForm">
        <div class="mb-3">
          <label for="firstName" class="form-label">Anarana voalohany</label>
          <input type="text" class="form-control" id="firstName" required>
        </div>
        
        <div class="mb-3">
          <label for="securityCode" class="form-label">Teny miafina</label>
          <input type="password" class="form-control" id="securityCode" required>
          <div class="form-text">Admin: Rakoto12</div>
        </div>
        
        <button type="submit" class="btn btn-professional w-100">
          <i class="fas fa-sign-in-alt me-1"></i> Hiditra
        </button>
        
        <div class="mt-3 text-center">
          <p>Tsy manana kaonty? <a href="#" id="signupLink">Hisoratra anarana</a></p>
        </div>
      </form>
    </div>
  </div>

  <!-- Page principale (cachée par défaut) -->
  <div id="appContainer" class="app-container" style="display:none;">
    <div class="header professional-gradient">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="app-title">Microtâche Mila Vola</h1>
            <p class="app-subtitle">Plateforme pour gagner de l'argent en réalisant des microtâches</p>
          </div>
          <div class="col-md-4 text-end">
            <div class="d-flex align-items-center justify-content-end">
              <div class="d-inline-block bg-white text-dark p-2 rounded-circle me-2">
                <i class="fas fa-user fa-lg text-primary"></i>
              </div>
              <button id="logoutBtn" class="logout-btn">
                <i class="fas fa-sign-out-alt me-1"></i> Hivoaka
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="firebaseStatus" class="firebase-status status-connected">
      <i class="fas fa-circle-check"></i> Firebase Connected
    </div>

    <div class="container">
      <!-- Stats Section -->
      <div class="section-card professional-shadow">
        <div class="stats-container">
          <div class="stat-item-professional">
            <div class="stat-number">152</div>
            <div class="stat-label">Tâches Complétées</div>
          </div>
          <div class="stat-item-professional">
            <div class="stat-number">78</div>
            <div class="stat-label">Utilisateurs Actifs</div>
          </div>
          <div class="stat-item-professional">
            <div class="stat-number">1.2M Ar</div>
            <div class="stat-label">Gains Distribués</div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="nav nav-pills justify-content-center mb-4">
        <a class="nav-link" href="#adminSection"><i class="fas fa-cog me-1"></i> Admin</a>
        <a class="nav-link active" href="#accountSection"><i class="fas fa-wallet me-1"></i> Compte</a>
        <a class="nav-link" href="#tasksSection"><i class="fas fa-tasks me-1"></i> Asa</a>
        <a class="nav-link" href="#publicationSection"><i class="fas fa-bullhorn me-1"></i> Publication</a>
        <a class="nav-link" href="#settingsSection"><i class="fas fa-sliders-h me-1"></i> Paramètres</a>
      </nav>

      <!-- Admin Section -->
      <div id="adminSection" class="mb-5" style="display:none;">
        <h4 class="section-title"><i class="fas fa-cog me-2"></i>Admin Panel</h4>
        <div class="admin-card professional-shadow">
          <h5 class="admin-header"><i class="fas fa-money-bill-wave me-2"></i>Demandes de Dépôt</h5>
          <table class="admin-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Montant</th>
                <th>Méthode</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="depotList">
              <tr>
                <td colspan="5" class="text-center py-4">
                  <div class="empty-state py-0">
                    <i class="fas fa-inbox"></i>
                    <p>Aucune demande de dépôt en attente</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="admin-card professional-shadow">
          <h5 class="admin-header"><i class="fas fa-hand-holding-usd me-2"></i>Demandes de Retrait</h5>
          <table class="admin-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Montant</th>
                <th>Frais</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="retraitList">
              <tr>
                <td colspan="5" class="text-center py-4">
                  <div class="empty-state py-0">
                    <i class="fas fa-inbox"></i>
                    <p>Aucune demande de retrait en attente</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="admin-card professional-shadow">
          <h5 class="admin-header"><i class="fas fa-check-circle me-2"></i>Soumissions de Preuves</h5>
          <table class="admin-table">
            <thead>
              <tr>
                <th>Utilisateur</th>
                <th>Tâche</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="submissionList">
              <tr>
                <td colspan="4" class="text-center py-4">
                  <div class="empty-state py-0">
                    <i class="fas fa-inbox"></i>
                    <p>Aucune soumission de preuve en attente</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Compte Section -->
      <div id="accountSection" class="mb-5">
        <h4 class="section-title"><i class="fas fa-wallet me-2"></i>Compte</h4>
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="balance-card gain-card professional-shadow">
              <div class="balance-label">Solde de Gains</div>
              <div id="gainBalance" class="balance-amount">0 Ar</div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="balance-card deposit-card professional-shadow">
              <div class="balance-label">Solde de Dépôt</div>
              <div id="depositBalance" class="balance-amount">0 Ar</div>
            </div>
          </div>
        </div>
        
        <div class="d-grid gap-3 d-md-flex">
          <button class="btn btn-action btn-deposit professional-shadow" data-bs-toggle="modal" data-bs-target="#depositModal">
            <i class="fas fa-plus-circle me-1"></i> Dépôt
          </button>
          <button class="btn btn-action btn-withdraw professional-shadow" data-bs-toggle="modal" data-bs-target="#withdrawModal">
            <i class="fas fa-minus-circle me-1"></i> Retrait
          </button>
        </div>
      </div>

      <!-- Tasks Section -->
      <div id="tasksSection" class="mb-5">
        <h4 class="section-title"><i class="fas fa-tasks me-2"></i>Asa</h4>
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>Complétez des tâches pour gagner de l'argent. Chaque tâche validée rapporte 50 Ar.
        </div>
        <div id="taskList" class="row">
          <div class="col-12">
            <div class="empty-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement des tâches disponibles...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Publication Section -->
      <div id="publicationSection" class="mb-5" style="display:none;">
        <h4 class="section-title"><i class="fas fa-bullhorn me-2"></i>Publication</h4>
        <div class="section-card professional-shadow mb-4">
          <form id="publishForm" class="mb-3">
            <div class="mb-3">
              <label class="form-label">Description de la tâche</label>
              <textarea id="pubDescription" class="form-control mb-2" placeholder="Décrivez la tâche à réaliser" rows="3" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Budget (≥ 50 Ar)</label>
                <input id="pubBudget" type="number" class="form-control" placeholder="Ex: 100" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">URL/Information</label>
                <input id="pubURL" type="text" class="form-control" placeholder="Lien ou référence">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Conditions</label>
              <textarea id="pubConditions" class="form-control" placeholder="Conditions à respecter" rows="2"></textarea>
            </div>
            <button class="btn btn-primary btn-action professional-shadow">
              <i class="fas fa-paper-plane me-1"></i> Publier la tâche
            </button>
          </form>
        </div>
        
        <h5 class="mt-4 mb-3"><i class="fas fa-list me-2"></i>Mes Publications</h5>
        <div id="publicationList" class="row">
          <div class="col-12">
            <div class="empty-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Chargement de vos publications...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settingsSection" class="mb-5">
        <h4 class="section-title"><i class="fas fa-sliders-h me-2"></i>Paramètres</h4>
        <div class="section-card professional-shadow">
          <h5><i class="fas fa-user-friends me-2"></i>Programme de Parrainage</h5>
          <p>Invitez vos amis et gagnez 10% de leurs gains!</p>
          <div class="mt-3">
            <p class="mb-1">Votre code de parrainage:</p>
            <div class="referral-code" id="referralCode">Chargement...</div>
          </div>
          
          <div class="referral-link">
            <input type="text" class="form-control" id="referralLink" readonly>
            <button class="btn btn-outline-primary" onclick="copyReferralLink()">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          
          <div class="mt-3">
            <button class="btn btn-professional" onclick="shareReferral()">
              <i class="fas fa-share-alt me-1"></i> Partager
            </button>
          </div>
        </div>
      </div>

      <!-- Modals -->
      <!-- Deposit Modal -->
      <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog">
          <form id="depositForm" class="modal-content">
            <div class="modal-header card-header-gradient">
              <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Dépôt</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Montant (≥ 5000 Ar)</label>
                <input id="depositAmount" type="number" class="form-control" placeholder="Ex: 10000" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Méthode de Paiement</label>
                <select id="depositMethod" class="form-select" required>
                  <option value="">Sélectionnez une méthode</option>
                  <option value="Mvola">Mvola</option>
                  <option value="Orange Money">Orange Money</option>
                  <option value="Airtel Money">Airtel Money</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-professional">Envoyer</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Withdraw Modal -->
      <div class="modal fade" id="withdrawModal" tabindex="-1">
        <div class="modal-dialog">
          <form id="withdrawForm" class="modal-content">
            <div class="modal-header card-header-gradient">
              <h5 class="modal-title"><i class="fas fa-minus-circle me-2"></i>Retrait</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Nom Complet</label>
                <input id="withdrawName" type="text" class="form-control" placeholder="Votre nom" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Numéro de Téléphone</label>
                <input id="withdrawPhone" type="tel" class="form-control" placeholder="Votre numéro" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Montant (≥ 10000 Ar)</label>
                <input id="withdrawAmount" type="number" class="form-control" placeholder="Ex: 20000" required>
                <div class="form-text">Frais: 10% du montant</div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-professional">Envoyer</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Proof Modal -->
      <div class="modal fade" id="proofModal" tabindex="-1">
        <div class="modal-dialog">
          <form id="submitProofForm" class="modal-content">
            <input id="taskIdHidden" type="hidden">
            <div class="modal-header card-header-gradient">
              <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Envoyer Preuve</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Votre Identifiant</label>
                <input id="userName" type="text" class="form-control" placeholder="Nom/Email/Instagram" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Preuve de Réalisation</label>
                <textarea id="userProof" class="form-control" placeholder="Texte ou URL d'image" rows="3" required></textarea>
                <div class="form-text">Fournissez un lien ou décrivez votre preuve</div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-professional">Envoyer</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <footer>
      <div class="container">
        <p class="mb-0">Microtâche Mila Vola &copy; 2023 - Plateforme de microtâches</p>
        <p class="mb-0">Contact: support@milavola.mg | +261 34 00 000 00</p>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDoc, doc,
      serverTimestamp, query, where, getDocs, setDoc,
      updateDoc, deleteDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAC-P6WFH1kqfYQi3PdCWpy4LSUqvtX_vo",
      authDomain: "mila-vola.firebaseapp.com",
      projectId: "mila-vola",
      storageBucket: "mila-vola.appspot.com",
      messagingSenderId: "690624768352",
      appId: "1:690624768352:web:668994ef2664c5b99dd605",
      measurementId: "G-C3FZTKQHFP"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Update Firebase status
    const firebaseStatus = document.getElementById('firebaseStatus');
    firebaseStatus.innerHTML = '<i class="fas fa-circle-check"></i> Firebase Connected';

    // Variables globales
    let userId = "";
    let isAdmin = false;
    let userName = "";

    // Page elements
    const loginPage = document.getElementById('loginPage');
    const appContainer = document.getElementById('appContainer');
    const logoutBtn = document.getElementById('logoutBtn');

    // Vérifier si l'utilisateur est déjà connecté
    function checkLoginStatus() {
      const savedUser = localStorage.getItem('milaVolaUser');
      if (savedUser) {
        const userData = JSON.parse(savedUser);
        userId = userData.id;
        userName = userData.name;
        isAdmin = userData.isAdmin;
        
        // Masquer la page de connexion et afficher l'application
        loginPage.style.display = 'none';
        appContainer.style.display = 'block';
        
        // Charger l'application
        loadApplication();
      }
    }

    // Gestion du formulaire de connexion
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const firstName = document.getElementById('firstName').value.trim();
      const securityCode = document.getElementById('securityCode').value;
      
      if (!firstName || !securityCode) {
        alert('Ampidiro ny anarana sy ny teny miafina');
        return;
      }
      
      // Vérifier si le code d'accès est celui de l'admin
      const adminAccess = securityCode === "Rakoto12";
      
      // Créer un ID utilisateur basé sur le nom
      const userID = firstName.toLowerCase().replace(/\s+/g, '-') + '-' + Math.floor(1000 + Math.random() * 9000);
      
      try {
        // Vérifier si l'utilisateur existe déjà
        const userRef = doc(db, "users", userID);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
          // Vérifier le mot de passe
          const userData = userSnap.data();
          if (userData.securityCode !== securityCode) {
            alert('Teny miafina diso!');
            return;
          }
        } else {
          // Créer un nouvel utilisateur
          await setDoc(userRef, {
            name: firstName,
            securityCode: securityCode,
            gain: 0,
            depot: 0,
            createdAt: serverTimestamp(),
            isAdmin: adminAccess,
            completedTasks: [] // Liste des tâches complétées
          });
        }
        
        // Récupérer les informations de l'utilisateur
        const userDoc = await getDoc(userRef);
        const userData = userDoc.data();
        
        // Stocker les informations de l'utilisateur
        userId = userID;
        userName = userData.name;
        isAdmin = userData.isAdmin || adminAccess;
        
        // Sauvegarder dans localStorage
        localStorage.setItem('milaVolaUser', JSON.stringify({
          id: userId,
          name: userName,
          isAdmin: isAdmin
        }));
        
        // Masquer la page de connexion et afficher l'application
        loginPage.style.display = 'none';
        appContainer.style.display = 'block';
        
        // Charger l'application
        loadApplication();
        
      } catch (error) {
        console.error("Erreur de connexion:", error);
        alert("Erreur de connexion: " + error.message);
      }
    });

    // Déconnexion
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('milaVolaUser');
      location.reload();
    });

    // Charger l'application après connexion
    async function loadApplication() {
      await loadBalances();
      await loadTasks();
      await loadPublications();
      document.getElementById("referralCode").textContent = userId;
      document.getElementById('referralLink').value = window.location.href.split('?')[0] + '?ref=' + userId;
      
      // Afficher le nom de l'utilisateur dans le header
      document.querySelector('.app-subtitle').textContent = `Bienvenue, ${userName}!`;
      
      // Gestion des sections admin/publication
      if (isAdmin) {
        document.getElementById('adminSection').style.display = 'block';
        document.getElementById('publicationSection').style.display = 'block';
      } else {
        document.getElementById('adminSection').style.display = 'none';
        document.getElementById('publicationSection').style.display = 'none';
      }
      
      // Setup real-time listeners
      setupRealtimeListeners();
    }

    // --- Section Compte ---
    async function loadBalances() {
      try {
        const userRef = doc(db, "users", userId);
        const snap = await getDoc(userRef);
        const data = snap.exists() ? snap.data() : { gain: 0, depot: 0 };
        document.getElementById("gainBalance").textContent = data.gain + " Ar";
        document.getElementById("depositBalance").textContent = data.depot + " Ar";
      } catch (error) {
        console.error("Error loading balances:", error);
      }
    }

    document.getElementById("depositForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const montant = parseFloat(document.getElementById("depositAmount").value);
      const method = document.getElementById("depositMethod").value;
      
      if (montant >= 5000 && method) {
        try {
          await addDoc(collection(db, "depot_requests"), {
            userId, userName, montant, method,
            status: "en attente", createdAt: serverTimestamp()
          });
          alert("Dépôt voaray! Votre demande est en cours de traitement.");
          
          // Reset form and close modal
          e.target.reset();
          bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
        } catch (error) {
          alert("Erreur lors du dépôt: " + error.message);
        }
      } else {
        alert("Ampidiro araka ny tokony ho izy ny vola (min 5000 Ar) sy fomba fandoavana.");
      }
    });

    document.getElementById("withdrawForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nom = document.getElementById("withdrawName").value;
      const phone = document.getElementById("withdrawPhone").value;
      const montant = parseFloat(document.getElementById("withdrawAmount").value);
      
      if (montant >= 10000) {
        try {
          const frais = montant * 0.1;
          await addDoc(collection(db, "retrait_requests"), {
            userId, userName, nom, phone, montant, frais,
            status: "en attente", createdAt: serverTimestamp()
          });
          alert("Retrait voaray! Votre demande est en cours de traitement.");
          
          // Reset form and close modal
          e.target.reset();
          bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
        } catch (error) {
          alert("Erreur lors du retrait: " + error.message);
        }
      } else {
        alert("Tsara indrindra ny ≥ 10000 Ar");
      }
    });

    // --- Section Asa (Proof) ---
    async function loadTasks() {
      try {
        const list = document.getElementById("taskList");
        list.innerHTML = '';
        
        // Récupérer les tâches complétées par l'utilisateur
        const userRef = doc(db, "users", userId);
        const userSnap = await getDoc(userRef);
        const completedTasks = userSnap.exists() ? userSnap.data().completedTasks || [] : [];
        
        const q = query(collection(db, "tasks"), where("status","==","active"));
        const snap = await getDocs(q);
        
        if (snap.empty) {
          list.innerHTML = `
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-tasks"></i>
                <p>Aucune tâche disponible pour le moment</p>
              </div>
            </div>
          `;
          return;
        }
        
        list.innerHTML = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const taskId = docSnap.id;
          
          // Vérifier si la tâche est déjà complétée
          const isCompleted = completedTasks.includes(taskId);
          
          const el = document.createElement('div');
          el.className = isCompleted ? 'col-md-4 mb-3 completed-task' : 'col-md-4 mb-3';
          el.innerHTML = `
            <div class="task-card card">
              <div class="card-body">
                <span class="task-badge">${d.budget} Ar</span>
                <h6 class="card-title">${d.description}</h6>
                <small class="d-block text-muted mb-2">Conditions: ${d.cond || 'Aucune'}</small>
                ${isCompleted ? '' : `
                <button class='btn btn-primary w-100 mt-3' onclick='openProofModal("${taskId}")'>
                  <i class="fas fa-paper-plane me-1"></i> Envoyer preuve
                </button>
                `}
              </div>
            </div>
          `;
          list.appendChild(el);
        });
      } catch (error) {
        console.error("Error loading tasks:", error);
      }
    }

    document.getElementById("submitProofForm").addEventListener("submit", async e => {
      e.preventDefault();
      const taskId = document.getElementById("taskIdHidden").value;
      const name = document.getElementById("userName").value;
      const proof = document.getElementById("userProof").value;
      
      if (!taskId || !name || !proof) {
        alert("Ampidiro ny angona rehetra");
        return;
      }
      
      try {
        const key = `${userId}_${taskId}`;
        await setDoc(doc(db,"submissions",key),{
          userId, userName, taskId, name, proof,
          status:"en attente", createdAt: serverTimestamp()
        });
        alert("Porofo nalefa! Ny mpitantana dia handinika azy.");
        
        // Reset form and close modal
        e.target.reset();
        bootstrap.Modal.getInstance(document.getElementById('proofModal')).hide();
      } catch (error) {
        alert("Erreur lors de l'envoi de la preuve: " + error.message);
      }
    });

    window.openProofModal = id => {
      document.getElementById('taskIdHidden').value = id;
      new bootstrap.Modal(document.getElementById('proofModal')).show();
    };

    // --- Section Publication ---
    async function loadPublications() {
      try {
        const list = document.getElementById('publicationList');
        list.innerHTML = '';
        
        const q = query(collection(db,'tasks'), where('publisher','==',userId));
        const snap = await getDocs(q);
        
        if (snap.empty) {
          list.innerHTML = `
            <div class="col-12">
              <div class="empty-state">
                <i class="fas fa-bullhorn"></i>
                <p>Vous n'avez publié aucune tâche</p>
              </div>
            </div>
          `;
          return;
        }
        
        list.innerHTML = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const el = document.createElement('div');
          el.className = 'col-md-6 mb-3';
          el.innerHTML = `
            <div class="card task-card">
              <div class="card-body">
                <h6>${d.description}</h6>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span class="badge bg-warning">${d.budget} Ar</span>
                  <span class="badge bg-success">Active</span>
                </div>
              </div>
            </div>
          `;
          list.appendChild(el);
        });
      } catch (error) {
        console.error("Error loading publications:", error);
      }
    }

    document.getElementById('publishForm').addEventListener('submit', async e => {
      e.preventDefault();
      const desc = document.getElementById('pubDescription').value;
      const budget = parseInt(document.getElementById('pubBudget').value);
      const url = document.getElementById('pubURL').value;
      const cond = document.getElementById('pubConditions').value;
      
      if (budget >= 50) {
        try {
          await addDoc(collection(db,'tasks'),{
            publisher:userId, publisherName: userName, description:desc, budget, url, cond,
            status:'active', createdAt:serverTimestamp()
          });
          alert('Asa navoaka!');
          loadPublications();
          
          // Reset form
          e.target.reset();
        } catch (error) {
          alert("Erreur lors de la publication: " + error.message);
        }
      } else {
        alert('Budget ≥ 50 Ar');
      }
    });

    // --- Section Admin ---
    async function loadAdminPanel() {
      await loadRequests('depot_requests','depotList','depot');
      await loadRequests('retrait_requests','retraitList','retrait');
      await loadRequests('submissions','submissionList','proof');
    }
    
    async function loadRequests(col, container, type) {
      try {
        const c = document.getElementById(container);
        c.innerHTML = '';
        
        const q = query(collection(db, col), where('status','==','en attente'));
        const snap = await getDocs(q);
        
        if (snap.empty) {
          c.innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-4">
                <div class="empty-state py-0">
                  <i class="fas fa-inbox"></i>
                  <p>Aucune demande en attente</p>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue';
          const el = document.createElement('tr');
          
          if (type === 'depot') {
            el.innerHTML = `
              <td>${d.userName || d.userId}</td>
              <td>${d.montant} Ar</td>
              <td>${d.method}</td>
              <td>${date}</td>
              <td class="admin-actions">
                <button class='btn btn-success btn-sm me-1' onclick='confirmAction("${col}","${docSnap.id}","${type}",${JSON.stringify(d)})'>
                  <i class="fas fa-check me-1"></i>
                </button>
                <button class='btn btn-danger btn-sm' onclick='cancelAction("${col}","${docSnap.id}")'>
                  <i class="fas fa-times me-1"></i>
                </button>
              </td>
            `;
          } else if (type === 'retrait') {
            el.innerHTML = `
              <td>${d.nom || d.userName || d.userId}</td>
              <td>${d.montant} Ar</td>
              <td>${d.frais || 0} Ar</td>
              <td>${date}</td>
              <td class="admin-actions">
                <button class='btn btn-success btn-sm me-1' onclick='confirmAction("${col}","${docSnap.id}","${type}",${JSON.stringify(d)})'>
                  <i class="fas fa-check me-1"></i>
                </button>
                <button class='btn btn-danger btn-sm' onclick='cancelAction("${col}","${docSnap.id}")'>
                  <i class="fas fa-times me-1"></i>
                </button>
              </td>
            `;
          } else if (type === 'proof') {
            el.innerHTML = `
              <td>${d.userName || d.userId}</td>
              <td>${d.taskId || 'Inconnue'}</td>
              <td>${date}</td>
              <td class="admin-actions">
                <button class='btn btn-success btn-sm me-1' onclick='confirmAction("${col}","${docSnap.id}","${type}",${JSON.stringify(d)})'>
                  <i class="fas fa-check me-1"></i>
                </button>
                <button class='btn btn-danger btn-sm' onclick='cancelAction("${col}","${docSnap.id}")'>
                  <i class="fas fa-times me-1"></i>
                </button>
              </td>
            `;
          }
          
          c.appendChild(el);
        });
      } catch (error) {
        console.error(`Error loading ${col}:`, error);
      }
    }

    window.confirmAction = async (col, id, type, d) => {
      try {
        await updateDoc(doc(db, col, id), {status: 'confirmé'});
        
        const uRef = doc(db, 'users', d.userId);
        const uSnap = await getDoc(uRef);
        const u = uSnap.exists() ? uSnap.data() : {gain: 0, depot: 0};
        
        if (type === 'depot') {
          await updateDoc(uRef, {depot: u.depot + d.montant});
        } else if (type === 'retrait') {
          await updateDoc(uRef, {depot: u.depot - (d.montant + d.frais)});
        } else if (type === 'proof') {
          // Mettre à jour le solde de gain
          await updateDoc(uRef, {gain: u.gain + 50});
          
          // Ajouter la tâche complétée à la liste de l'utilisateur
          const completedTasks = u.completedTasks || [];
          if (!completedTasks.includes(d.taskId)) {
            completedTasks.push(d.taskId);
            await updateDoc(uRef, {completedTasks});
          }
        }
        
        alert('Nohamarina!');
        loadAdminPanel();
        loadBalances();
      } catch (error) {
        alert("Erreur lors de la confirmation: " + error.message);
      }
    };

    window.cancelAction = async (col, id) => {
      try {
        await deleteDoc(doc(db, col, id));
        alert('Nofoanana');
        loadAdminPanel();
      } catch (error) {
        alert("Erreur lors de l'annulation: " + error.message);
      }
    };

    // Setup real-time listeners for balances
    function setupRealtimeListeners() {
      const userRef = doc(db, "users", userId);
      
      onSnapshot(userRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          document.getElementById("gainBalance").textContent = data.gain + " Ar";
          document.getElementById("depositBalance").textContent = data.depot + " Ar";
        }
      });
    }

    // Fonctions pour le parrainage
    function copyReferralLink() {
      const link = document.getElementById('referralLink');
      link.select();
      document.execCommand('copy');
      alert('Lien copié dans le presse-papiers!');
    }

    function shareReferral() {
      if (navigator.share) {
        navigator.share({
          title: 'Microtâche Mila Vola',
          text: 'Rejoignez la plateforme Microtâche Mila Vola et gagnez de l\'argent en réalisant des microtâches!',
          url: document.getElementById('referralLink').value
        })
        .catch(error => console.log('Erreur de partage:', error));
      } else {
        copyReferralLink();
      }
    }

    // Vérifier le paramètre de référence dans l'URL
    function checkReferral() {
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      if (ref) {
        document.getElementById('securityCode').value = ref;
        alert('Vous avez été invité par un parrain! Utilisez le code d\'accès pour bénéficier des avantages.');
      }
    }

    // Vérifier le statut de connexion au chargement
    checkLoginStatus();
    checkReferral();
  </script>
</body>
</html>
